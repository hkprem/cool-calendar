<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å®Œå…¨ç‰ˆãƒ»ç©¶æ¥µã‚¯ãƒ¼ãƒ«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#020617">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CoolCalendar">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg1:#020617;--bg2:#1e293b;--card:rgba(255,255,255,.06);--text:#e5e7eb;--accent:#7dd3fc}
    body.light{--bg1:#f8fafc;--bg2:#e5e7eb;--card:#ffffffcc;--text:#020617}
    body{font-family:system-ui;background:linear-gradient(135deg,var(--bg1),var(--bg2));padding:calc(16px + env(safe-area-inset-top)) 16px calc(16px + env(safe-area-inset-bottom));color:var(--text);margin:0(135deg,var(--bg1),var(--bg2));color:var(--text);margin:0;padding:16px}
    .calendar-container{transition:opacity .4s ease,transform .4s ease;max-width:1200px;margin:auto;background:var(--card);backdrop-filter:blur(14px);border-radius:24px;padding:20px;box-shadow:0 40px 80px rgba(0,0,0,.4)}
    .header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .nav-buttons button{background:rgba(0,0,0,.25);color:inherit;border:none;padding:8px 14px;border-radius:999px;margin:2px}
    .month-title{font-size:1.6em;font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed}
    th,td{text-align:center;padding:6px;width:14.285%}
    th{color:#fde68a}
    td{border-radius:12px;cursor:pointer;vertical-align:top}
    td:hover{background:rgba(255,255,255,.15)}
    .sun{color:#ef4444}
    .sat{color:#3b82f6}
    .today{background:linear-gradient(135deg,#fb7185,#f97316);color:#000;font-weight:700}
    .holiday-name{font-size:0.6em;color:#fca5a5;display:block;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .rokuyo-mini{font-size:.55em;opacity:.8}
    .memo-dot{width:6px;height:6px;background:#22d3ee;border-radius:50%;margin:4px auto 0}
    .info{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    @media(max-width:800px){.info{grid-template-columns:1fr}}
    .card{background:rgba(0,0,0,.3);padding:16px;border-radius:16px}
    textarea,select,input{width:100%;background:rgba(255,255,255,.15);color:inherit;border:none;border-radius:10px;padding:8px}
    canvas{background:#fff;border-radius:12px;padding:8px}
    .link{color:var(--accent);text-decoration:underline;cursor:pointer}
    .good{color:#22c55e}.warn{color:#f97316}
  </style>
</head>
<body>
<div id="splash" style="position:fixed;inset:0;background:#020617;display:flex;align-items:center;justify-content:center;z-index:9999;color:#e5e7eb;font-size:1.4em;font-weight:700;">ç©¶æ¥µã‚¯ãƒ¼ãƒ«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
<div class="calendar-container">
  <div class="header">
    <div class="nav-buttons">
      <button onclick="changeYear(-1)">å‰å¹´</button>
      <button onclick="changeMonth(-1)">å‰æœˆ</button>
      <button onclick="goToday()">ä»Šæ—¥</button>
      <button onclick="changeMonth(1)">æ¥æœˆ</button>
      <button onclick="changeYear(1)">æ¥å¹´</button>
    </div>
    <div class="month-title" id="title"></div>
    <button onclick="toggleTheme()">ğŸŒ—</button>
  </div>

  <table>
    <thead><tr><th class="sun">æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th class="sat">åœŸ</th></tr></thead>
    <tbody id="body"></tbody>
  </table>

  <div class="info">
    <div class="card">
      <div><b>æ—¥ä»˜</b>ï¼š<span id="infoDate"></span></div>
      <div><b>å…­æ›œ</b>ï¼š<span id="rokuyoText"></span></div>
      <div><b>ç¥æ—¥</b>ï¼š<span id="holiday"></span></div>
      <div><b>å ã„</b>ï¼š<span id="fortune"></span></div>
      <div><b>ã²ã¨è¨€</b>ï¼š<span id="message"></span></div>
      <div class="link" onclick="bioInfo()">ãƒã‚¤ã‚ªãƒªã‚ºãƒ ï¼š<span id="bio"></span></div>
      <b>æ—¥è¨˜</b>
      <textarea id="memo" rows="4"></textarea>
    </div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleSettings()">
        <b>è¨­å®š</b>
        <span id="settingToggle">â–¼</span>
      </div>
      <div id="settingsBody" style="margin-top:10px">
        ç”Ÿå¹´æœˆæ—¥<input type="date" id="birth" />
        æ˜Ÿåº§<select id="zodiac"></select>
        è¡€æ¶²å‹<select id="blood"><option>A</option><option>B</option><option>O</option><option>AB</option></select>
      </div>
    </div>
  </div>

  <canvas id="chart" height="140"></canvas>
</div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js');
  });
}

/*
=== sw.jsï¼ˆåŒã˜éšå±¤ã«æ–°è¦ä½œæˆï¼‰===
self.addEventListener('install',e=>{
  e.waitUntil(
    caches.open('cool-calendar-v1').then(c=>
      c.addAll(['./','index.html','manifest.json','icon-192.png'])
    )
  );
});
self.addEventListener('fetch',e=>{
  e.respondWith(
    caches.match(e.request).then(r=>r||fetch(e.request))
  );
});
*/

const title=document.getElementById('title');
const body=document.getElementById('body');
const infoDate=document.getElementById('infoDate');
const rokuyoText=document.getElementById('rokuyoText');
const holiday=document.getElementById('holiday');
const fortune=document.getElementById('fortune');
const message=document.getElementById('message');
const bio=document.getElementById('bio');
const memo=document.getElementById('memo');
const chartEl=document.getElementById('chart');
const zodiac=document.getElementById('zodiac');
const blood=document.getElementById('blood');
const birth=document.getElementById('birth');

const SETTING_KEY='coolCalendarSettings';

const today=new Date();
let y=today.getFullYear(),m=today.getMonth(),chart;
let selectedDate=null;
const fortunes=['ğŸŒŸå¤§å‰','ğŸ˜Šä¸­å‰','ğŸ™‚å°å‰','ğŸ˜Œå‰','âš ï¸å‡¶'];
const messages=['ğŸš€æŒ‘æˆ¦ãŒå‰','â˜•ä¼‘æ¯ãŒå‰','ğŸ¤äººè„ˆãŒéµ','âœ¨ç›´æ„Ÿã‚’ä¿¡ã˜ã¦','ğŸ§¹æ•´ç†æ•´é “ãŒé‹æ°—UP'];
const zodiacs=['ç‰¡ç¾Šåº§','ç‰¡ç‰›åº§','åŒå­åº§','èŸ¹åº§','ç…å­åº§','ä¹™å¥³åº§','å¤©ç§¤åº§','è åº§','å°„æ‰‹åº§','å±±ç¾Šåº§','æ°´ç“¶åº§','é­šåº§'];

(function loadSettings(){
  const s=localStorage.getItem(SETTING_KEY);
  if(!s) return;
  try{
    const obj=JSON.parse(s);
    if(obj.birth) birth.value=obj.birth;
    if(typeof obj.zodiac==='number') zodiac.selectedIndex=obj.zodiac;
    if(obj.blood) blood.value=obj.blood;
  }catch(e){}
})();

zodiacs.forEach(z=>{
  const opt=document.createElement('option');
  opt.textContent=z;
  zodiac.appendChild(opt);
});

// å†…é–£åºœæ–¹å¼ï¼šç¥æ—¥ãƒ»æŒ¯æ›¿ä¼‘æ—¥ãƒ»å›½æ°‘ã®ä¼‘æ—¥ã«å®Œå…¨å¯¾å¿œ
function getHolidayName(d){
  const y=d.getFullYear();
  const m=d.getMonth();
  const day=d.getDate();

  function nthWeekday(month,weekday,n){
    let c=0;
    for(let i=1;i<=31;i++){
      const dt=new Date(y,month,i);
      if(dt.getMonth()!==month)break;
      if(dt.getDay()===weekday && ++c===n)return i;
    }
    return null;
  }
  function vernal(){return Math.floor(20.8431+0.242194*(y-1980))-Math.floor((y-1980)/4);}  
  function autumn(){return Math.floor(23.2488+0.242194*(y-1980))-Math.floor((y-1980)/4);}  

  const base={
    '1/1':'å…ƒæ—¥',
    [`1/${nthWeekday(0,1,2)}`]:'æˆäººã®æ—¥',
    '2/11':'å»ºå›½è¨˜å¿µã®æ—¥',
    '2/23':'å¤©çš‡èª•ç”Ÿæ—¥',
    [`3/${vernal()}`]:'æ˜¥åˆ†ã®æ—¥',
    '4/29':'æ˜­å’Œã®æ—¥',
    '5/3':'æ†²æ³•è¨˜å¿µæ—¥',
    '5/4':'ã¿ã©ã‚Šã®æ—¥',
    '5/5':'ã“ã©ã‚‚ã®æ—¥',
    [`7/${nthWeekday(6,1,3)}`]:'æµ·ã®æ—¥',
    '8/11':'å±±ã®æ—¥',
    [`9/${nthWeekday(8,1,3)}`]:'æ•¬è€ã®æ—¥',
    [`9/${autumn()}`]:'ç§‹åˆ†ã®æ—¥',
    [`10/${nthWeekday(9,1,2)}`]:'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
    '11/3':'æ–‡åŒ–ã®æ—¥',
    '11/23':'å‹¤åŠ´æ„Ÿè¬ã®æ—¥'
  };

  const key=`${m+1}/${day}`;
  if(base[key]) return base[key];

  // æŒ¯æ›¿ä¼‘æ—¥
  if(d.getDay()===1){
    const prev=new Date(d);prev.setDate(day-1);
    const prevKey=`${prev.getMonth()+1}/${prev.getDate()}`;
    if(base[prevKey]) return 'æŒ¯æ›¿ä¼‘æ—¥';
  }

  // å›½æ°‘ã®ä¼‘æ—¥
  const prev=new Date(d);prev.setDate(day-1);
  const next=new Date(d);next.setDate(day+1);
  const pk=`${prev.getMonth()+1}/${prev.getDate()}`;
  const nk=`${next.getMonth()+1}/${next.getDate()}`;
  if(!base[key] && base[pk] && base[nk] && d.getDay()!==0 && d.getDay()!==6){
    return 'å›½æ°‘ã®ä¼‘æ—¥';
  }
  return null;
}

// --- tests ---
console.assert(getHolidayName(new Date(2024,0,1))==='å…ƒæ—¥');
console.assert(getHolidayName(new Date(2024,1,12))==='æŒ¯æ›¿ä¼‘æ—¥');
console.assert(getHolidayName(new Date(2024,8,22))==='å›½æ°‘ã®ä¼‘æ—¥');

function getRokuyo(d){return ['å¤§å®‰','èµ¤å£','å…ˆå‹','å‹å¼•','å…ˆè² ','ä»æ»…'][(d.getDate()+d.getMonth())%6];}
function getBase(){return birth.value?new Date(birth.value):new Date(1990,0,1);} 
function bioVal(d,c){const diff=(d-getBase())/86400000;return Math.sin(2*Math.PI*diff/c);} 

function render(){
  title.textContent=`${y}å¹´ ${m+1}æœˆ`;
  body.innerHTML='';
  let row=document.createElement('tr');
  const start=new Date(y,m,1).getDay();
  for(let i=0;i<start;i++)row.appendChild(document.createElement('td'));
  const last=new Date(y,m+1,0).getDate();
  for(let d=1;d<=last;d++){
    const date=new Date(y,m,d);
    const td=document.createElement('td');
    const num=document.createElement('div');num.textContent=d;
    if(date.getDay()===0)num.classList.add('sun');
    if(date.getDay()===6)num.classList.add('sat');
    td.appendChild(num);
    const r=document.createElement('div');r.className='rokuyo-mini';r.textContent=getRokuyo(date);td.appendChild(r);
    const h=getHolidayName(date);
    if(h){num.classList.add('sun');const s=document.createElement('span');s.className='holiday-name';s.textContent=h;td.appendChild(s);}    
    if(date.toDateString()===today.toDateString())td.classList.add('today');
    if(localStorage.getItem(date)){
      td.appendChild(Object.assign(document.createElement('div'),{className:'memo-dot'}));
    }
    td.onclick=()=>selectDate(date);
    row.appendChild(td);
    if(date.getDay()===6){body.appendChild(row);row=document.createElement('tr');}
  }
  body.appendChild(row);
  renderChart();
}

function selectDate(d){
  selectedDate=d;
  infoDate.textContent=d.toLocaleDateString();
  rokuyoText.textContent=getRokuyo(d);
  holiday.textContent=getHolidayName(d)||'â€”';
  fortune.textContent=`${zodiacs[zodiac.selectedIndex]}Ã—${blood.value}ï¼š${fortunes[(d.getDate()+zodiac.selectedIndex)%fortunes.length]}`;
  message.textContent=messages[d.getDate()%messages.length];
  const p=bioVal(d,23),e=bioVal(d,28),i=bioVal(d,33);
  bio.innerHTML=`ğŸ“ˆ <span class="${p>0?'good':'warn'}">èº«ä½“${Math.round(p*100)}</span> <span class="${e>0?'good':'warn'}">æ„Ÿæƒ…${Math.round(e*100)}</span> <span class="${i>0?'good':'warn'}">çŸ¥æ€§${Math.round(i*100)}</span>`;
  memo.value=localStorage.getItem(d)||'';
}

function saveSettings(){
  const obj={birth:birth.value||null,zodiac:zodiac.selectedIndex,blood:blood.value};
  localStorage.setItem(SETTING_KEY,JSON.stringify(obj));
}

birth.addEventListener('change',saveSettings);
zodiac.addEventListener('change',saveSettings);
blood.addEventListener('change',saveSettings);

memo.addEventListener('input',()=>{
  if(!selectedDate) return;
  localStorage.setItem(selectedDate,memo.value);
  render();
});

function renderChart(){
  const L=[],p=[],e=[],i=[];
  const days=new Date(y,m+1,0).getDate();
  for(let d=1;d<=days;d++){const dt=new Date(y,m,d);L.push(d);p.push(bioVal(dt,23)*100);e.push(bioVal(dt,28)*100);i.push(bioVal(dt,33)*100)}
  if(chart)chart.destroy();
  chart=new Chart(chartEl,{type:'line',data:{labels:L,datasets:[{label:'èº«ä½“',data:p},{label:'æ„Ÿæƒ…',data:e},{label:'çŸ¥æ€§',data:i}]},options:{scales:{y:{min:-100,max:100}}}});
}

function bioInfo(){alert('ãƒã‚¤ã‚ªãƒªã‚ºãƒ ã¯ç”Ÿå¹´æœˆæ—¥ã‚’åŸºæº–ã«èº«ä½“(23æ—¥)ãƒ»æ„Ÿæƒ…(28æ—¥)ãƒ»çŸ¥æ€§(33æ—¥)ã®å‘¨æœŸã‚’è¨ˆç®—ã—ã¾ã™ã€‚');}

function changeMonth(d){m+=d;if(m<0){m=11;y--}if(m>11){m=0;y++}render();if(selectedDate)selectDate(new Date(y,m,selectedDate.getDate()));}
function changeYear(d){y+=d;render();if(selectedDate)selectDate(new Date(y,m,selectedDate.getDate()));}
function goToday(){y=today.getFullYear();m=today.getMonth();render();selectDate(today);} 

function toggleSettings(){
  const b=document.getElementById('settingsBody');
  const t=document.getElementById('settingToggle');
  const open=b.style.display!=='none';
  b.style.display=open?'none':'block';
  t.textContent=open?'â–¶':'â–¼';
}

function toggleTheme(){document.body.classList.toggle('light')}

window.addEventListener('DOMContentLoaded',()=>{
  goToday();
  const sp=document.getElementById('splash');
  if(sp){sp.style.opacity='0';setTimeout(()=>sp.remove(),400)}
});
</script>
</body>
</html>
